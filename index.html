<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BatchConvert Pro - Premium Online File Converter</title>
    <meta name="description" content="Experience premium, secure batch file conversions. Convert multiple images to JPG, PNG, WebP, PDF, and more with BatchConvert Pro. Unlimited, fast, and user-friendly.">
    
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Manrope:wght@600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --font-primary: 'Inter', sans-serif;
            --font-headings: 'Manrope', sans-serif; /* Changed from Poppins */

            --color-background: #f0f2f5; /* Softer light gray */
            --color-surface: #ffffff;
            --color-surface-alt: #f7fafc; 
            --color-primary: #3B82F6;   /* A slightly more modern blue */
            --color-primary-dark: #2563EB;
            --color-secondary: #64748B; /* Slate gray */
            --color-text: #1E293B;      /* Darker charcoal for better contrast */
            --color-headings: #0F172A;  /* Even darker for headings */
            --color-border: #CBD5E1;    /* Softer border */
            --color-success: #10B981;   /* Tailwind green */
            --color-danger: #EF4444;    /* Tailwind red */
            --color-modal-overlay: rgba(15, 23, 42, 0.7); /* Darker overlay (from slate-900) */
            --color-icon-primary: var(--color-primary);

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            
            --border-radius-sm: 0.25rem; /* 4px */
            --border-radius-md: 0.5rem;  /* 8px */
            --border-radius-lg: 0.75rem; /* 12px */

            --space-xs: 0.25rem; /* 4px */
            --space-sm: 0.5rem;  /* 8px */
            --space-md: 1rem;    /* 16px */
            --space-lg: 1.5rem;  /* 24px */
            --space-xl: 2rem;    /* 32px */
            --space-xxl: 3rem;   /* 48px */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-primary);
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 0; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .page-wrapper {
            width: 100%;
            max-width: 1152px; /* xl tailwind size for overall content */
            padding: var(--space-lg) var(--space-md); /* Horizontal padding on mobile */
        }
        @media (min-width: 640px) { .page-wrapper { padding: var(--space-xl); } }


        .main-layout-grid {
            display: grid;
            grid-template-columns: 1fr; 
            gap: var(--space-xl);
            align-items: flex-start; 
        }
        @media (min-width: 1024px) { /* Desktop: two columns */
            .main-layout-grid {
                grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); /* Flexible columns */
                gap: var(--space-xxl);
            }
            .features-column {
                position: sticky;
                top: var(--space-xl); 
            }
        }

        .container { /* Main converter box */
            background: var(--color-surface);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            padding: var(--space-xl);
            text-align: center;
            color: white;
        }
        .header h1 { font-family: var(--font-headings); font-size: 2em; margin-bottom: var(--space-sm); font-weight: 800; }
        .header p { font-size: 1.05em; opacity: 0.9; max-width: 600px; margin-left: auto; margin-right: auto; }
        
        .main-content { padding: var(--space-xl); }
        
        .upload-area {
            border: 2px dashed var(--color-border); border-radius: var(--border-radius-md); padding: var(--space-xl); text-align: center; margin-bottom: var(--space-lg); background-color: var(--color-surface-alt); transition: all 0.2s ease-in-out; cursor: pointer;
        }
        .upload-area:hover, .upload-area.dragover { border-color: var(--color-primary); background-color: #DBEAFE; /* light blue from Tailwind */ }
        .upload-icon svg { width: 36px; height: 36px; stroke: var(--color-icon-primary); margin-bottom: var(--space-sm); }
        .upload-text { font-size: 1.05em; font-weight: 600; color: var(--color-headings); margin-bottom: var(--space-xs); }
        .upload-subtext { color: var(--color-secondary); font-size: 0.875em; }
        
        .file-input { display: none; }
        .format-selector { margin-bottom: var(--space-lg); }
        .format-selector label { display: block; font-weight: 600; margin-bottom: var(--space-sm); color: var(--color-headings); font-size: 0.95em; }
        .format-select { width: 100%; padding: 0.65rem 0.75rem; border: 1px solid var(--color-border); border-radius: var(--border-radius-md); font-size: 0.95em; background: var(--color-surface); color: var(--color-text); appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748B' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 0.85em; }
        .format-select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* Tailwind focus blue */ }

        .file-list-header { font-weight: 600; color: var(--color-headings); margin-bottom: var(--space-sm); font-size: 0.9em; padding-left: var(--space-xs); }
        .file-list { margin-bottom: var(--space-lg); }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm) var(--space-md); background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); margin-bottom: var(--space-sm); font-size: 0.875em; box-shadow: var(--shadow-sm); transition: box-shadow 0.2s ease; }
        .file-item:hover { box-shadow: var(--shadow-md); }
        .file-item-details { display: flex; flex-direction: column; flex-grow: 1; margin-right: var(--space-md); overflow: hidden; }
        .file-name { font-weight: 500; color: var(--color-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-size { color: var(--color-secondary); font-size: 0.9em; }
        .remove-file { background: transparent; color: var(--color-danger); border: none; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.875em; font-weight: 500; padding: var(--space-xs); display: flex; align-items: center; justify-content: center; transition: color 0.2s ease; line-height: 1; }
        .remove-file svg { width: 1.1em; height: 1.1em; stroke: currentColor; }
        .remove-file:hover { color: #B91C1C; /* Darker red on hover */ }
        
        .btn { display: inline-block; width: 100%; padding: 0.75rem var(--space-lg); border: 1px solid transparent; border-radius: var(--border-radius-md); font-size: 0.95em; font-weight: 600; font-family: var(--font-primary); cursor: pointer; text-align: center; transition: all 0.15s ease-in-out; box-shadow: var(--shadow-sm); }
        .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn:active { transform: translateY(0px); box-shadow: var(--shadow-sm); }
        .btn:disabled { background-color: #D1D5DB !important; color: #6B7280 !important; cursor: not-allowed !important; box-shadow: none !important; transform: none !important; border-color: transparent !important;}
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--color-primary-dark); }
        .btn-success { background-color: var(--color-success); color: white; }
        .btn-success:hover:not(:disabled) { background-color: #059669; }
        .btn-secondary { background-color: #E5E7EB; color: var(--color-headings); border-color: var(--color-border); } /* Light gray button */
        .btn-secondary:hover:not(:disabled) { background-color: #D1D5DB; }
        
        .payment-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-modal-overlay); z-index: 1000; align-items: center; justify-content: center; padding: var(--space-md); }
        .payment-modal.active { display: flex; }
        .payment-content { background: var(--color-surface); padding: var(--space-xl); border-radius: var(--border-radius-lg); text-align: center; max-width: 400px; width: 100%; box-shadow: var(--shadow-lg); }
        .payment-title { font-family: var(--font-headings); font-size: 1.4em; margin-bottom: var(--space-md); color: var(--color-headings); font-weight: 700; }
        .price { font-size: 2.25em; color: var(--color-primary); font-weight: 800; margin-bottom: var(--space-xs); }
        .price-subtext { color: var(--color-secondary); margin-bottom: var(--space-lg); font-size: 0.875em; }
        .pay-btn { margin-bottom: var(--space-md); }
        
        .features-section-wrapper { background-color: transparent; border-radius: 0; box-shadow: none; padding: 0; margin-bottom: var(--space-xxl); }
        /* If features are in a sidebar, they might not need their own card background */
        /* .features-column .features-section-wrapper { background-color: var(--color-surface); border-radius: var(--border-radius-lg); box-shadow: var(--shadow-md); padding: var(--space-xl); } */

        .features h2 { font-family: var(--font-headings); text-align: left; margin-bottom: var(--space-lg); color: var(--color-headings); font-size: 1.35em; font-weight: 700; border-bottom: 1px solid var(--color-border); padding-bottom: var(--space-sm); }
        .feature-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-xl); }
        /* Forcing single column for features if in sidebar */
        /* @media (min-width: 560px) and (max-width: 1023px) { .feature-grid { grid-template-columns: repeat(2, 1fr); } } */

        .feature { display: flex; align-items: flex-start; text-align: left; gap: var(--space-md); padding: 0; }
        .feature-icon { flex-shrink: 0; margin-top: var(--space-xs); } /* Align icon slightly */
        .feature-icon svg { width: 24px; height: 24px; stroke: var(--color-icon-primary); stroke-width: 2; }
        .feature-text-content {}
        .feature h3 { font-family: var(--font-headings); margin-bottom: var(--space-xs); color: var(--color-headings); font-size: 1em; font-weight: 700; }
        .feature p { color: var(--color-secondary); font-size: 0.875em; line-height: 1.5; }

        .seo-content-section { background: var(--color-surface); padding: var(--space-xl); max-width: 100%; margin: 0 auto; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-md); }
        .seo-content-section h2, .seo-content-section h3 { font-family: var(--font-headings); color: var(--color-headings); margin-top: var(--space-md); margin-bottom: var(--space-sm); }
        .seo-content-section h2 { font-size: 1.5em; }
        .seo-content-section h3 { font-size: 1.2em; }
        .seo-content-section p, .seo-content-section ul, .seo-content-section ol { margin-bottom: var(--space-md); line-height: 1.7; font-size: 0.95em; }
        .seo-content-section ul, .seo-content-section ol { margin-left: var(--space-lg); }
        .seo-content-section li { margin-bottom: var(--space-sm); }
        .seo-content-section em { font-style: italic; color: var(--color-secondary); font-size: 0.9em;}
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="main-layout-grid">
            <div class="converter-column">
                <div class="container">
                    <div class="header">
                        <h1>BatchConvert Pro</h1>
                        <p>Instantly convert multiple files online. Unlimited use, totally secure, blazing fast.</p>
                    </div>
                    <div class="main-content">
                        <div class="upload-area" id="uploadAreaTrigger" onclick="document.getElementById('fileInput').click()">
                            <div class="upload-icon">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21.2 15c.7-1.2 1-2.5.7-3.9-.6-2.1-2.4-3.5-4.4-3.5h-1.2c-.7-3-3.2-5.2-6.2-5.2S3.7 5.4 3 8.5H1.8c-1.1 0-2.1.5-2.8 1.3-.7.8-1 1.7-1 2.7 0 2.2 1.8 4 4 4h13.4c1.5 0 2.8-.8 3.4-2.1zM12 12v9"></path><path d="M16 16l-4-4-4 4"></path></svg>
                            </div>
                            <div class="upload-text">Drop files here or click to browse</div>
                            <div class="upload-subtext">Supports Images (JPG, PNG, WebP, etc.) & PDF from Image</div>
                        </div>
                        <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.tiff,.txt,.md,.csv,.json,.zip">
                        <div class="format-selector">
                            <label for="outputFormat">Convert selected files to:</label>
                            <select id="outputFormat" class="format-select">
                                <option value="">Select output format</option>
                                <optgroup label="Images">
                                    <option value="jpg">JPG</option>
                                    <option value="png">PNG</option>
                                    <option value="gif">GIF (Static)</option>
                                    <option value="webp">WebP</option>
                                    <option value="tiff">TIFF</option>
                                </optgroup>
                                <optgroup label="Documents">
                                    <option value="pdf">PDF (from Image)</option>
                                </optgroup>
                            </select>
                        </div>
                        <h3 class="file-list-header" id="fileListHeader" style="display:none;">Selected Files:</h3>
                        <div class="file-list" id="fileList"></div>
                        <button class="btn btn-primary convert-btn" id="convertBtn"></button>
                    </div>
                </div>
            </div>
            <div class="features-column">
                <div class="features-section-wrapper">
                    <div class="features">
                        <!-- <div class="inner-container"> No longer needed if padding on wrapper -->
                            <h2>Why BatchConvert Pro?</h2>
                            <div class="feature-grid">
                                <div class="feature">
                                    <div class="feature-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                                    </div>
                                    <div class="feature-text-content">
                                        <h3>Lightning Fast</h3>
                                        <p>Optimized engine for rapid batch file conversions.</p>
                                    </div>
                                </div>
                                <div class="feature">
                                    <div class="feature-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                                    </div>
                                    <div class="feature-text-content">
                                        <h3>Versatile Formats</h3>
                                        <p>Supports key image formats and PDF creation.</p>
                                    </div>
                                </div>
                                <div class="feature">
                                    <div class="feature-icon">
                                       <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                                    </div>
                                    <div class="feature-text-content">
                                        <h3>100% Secure</h3>
                                        <p>Files are processed securely and deleted promptly.</p>
                                    </div>
                                </div>
                                <div class="feature">
                                    <div class="feature-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2Z"></path><path d="M12 12L16 10" opacity=".4"></path><path d="M12 12L12 7" opacity=".4"></path><path d="M12 12L7 10.5" opacity=".4"></path><path d="M12 12L14 15" opacity=".4"></path><path d="M12 12L9 15.5" opacity=".4"></path></svg>
                                    </div>
                                    <div class="feature-text-content">
                                        <h3>Truly Unlimited</h3>
                                        <p>One-time payment for endless file conversions.</p>
                                    </div>
                                </div>
                            </div>
                        <!-- </div> -->
                    </div>
                </div>
            </div>
        </div> <!-- End .main-layout-grid -->

        <div class="payment-modal" id="paymentModal">
            <div class="payment-content">
                <h2 class="payment-title">Unlock Unlimited Conversions</h2>
                <div class="price">$12.99</div>
                <div class="price-subtext">One-time payment • Lifetime access • No monthly fees</div>
                <button class="btn btn-success pay-btn" onclick="processPayment()">Pay Now & Start Converting</button>
                <button class="btn btn-secondary close-modal-btn" onclick="closePayment()">Maybe Later</button>
            </div>
        </div>

        <div class="seo-content-section">
            <h2>Advanced Batch File Converter for All Your Needs</h2>
            <p>BatchConvert Pro is your ultimate solution for converting multiple files online efficiently. Whether you need to convert images to JPG, PNG, WebP, or create PDFs from images, our tool handles it seamlessly. Experience unlimited batch conversions without compromising on speed or security. Our intuitive interface makes it easy to upload and convert hundreds of files simultaneously.</p>
            <h3>Supported File Formats & Conversions</h3>
            <p>Currently, BatchConvert Pro excels at image conversions (JPG, PNG, GIF, WebP, TIFF to each other) and creating PDFs from various image formats. We are constantly working to expand our supported formats to include documents (DOCX, TXT), archives (ZIP), and more, all within our secure, high-performance batch processing engine. Our goal is to be the most comprehensive and user-friendly online batch converter.</p>
            <h3>Why BatchConvert Pro Stands Out</h3>
            <ul>
                <li><strong>Unlimited Conversions:</strong> No daily limits, no file count restrictions. Pay once, convert forever.</li>
                <li><strong>Speed & Efficiency:</strong> Optimized for fast processing of large batches of files.</li>
                <li><strong>High-Quality Output:</strong> Conversions maintain the highest possible quality.</li>
                <li><strong>Privacy Focused:</strong> Your files are automatically deleted from our servers after conversion.</li>
                <li><strong>User-Friendly Design:</strong> A clean, modern interface that's easy to navigate and use.</li>
            </ul>
            <h3>How to Convert Multiple Files with BatchConvert Pro</h3>
            <ol>
                <li>Drag and drop your files into the upload area, or click to browse your computer.</li>
                <li>Select your desired output format from the dropdown menu.</li>
                <li>Click the "Convert Files" button. (A one-time payment unlocks unlimited access).</li>
                <li>Your converted files will be bundled into a ZIP for easy download.</li>
            </ol>
            <p><em>Keywords: batch image converter, convert multiple files to pdf, online png to jpg batch, webp converter bulk, unlimited file conversion, secure file converter online.</em></p>
        </div>
    </div> <!-- End .page-wrapper -->

    <script>
        // --- JavaScript is IDENTICAL to the previous working version (with ZIP downloads) ---
        // --- No functional JS changes are made in this UI update ---
        let selectedFiles = [];
        const convertBtn = document.getElementById('convertBtn'); 
        const paymentModal = document.getElementById('paymentModal');
        const fileListHeader = document.getElementById('fileListHeader');
        
        document.getElementById('fileInput').addEventListener('change', function(e) { handleFiles(e.target.files); });
        const uploadArea = document.querySelector('.upload-area');
        uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
        uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
        uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
        
        function handleFiles(files) { for (let file of files) { selectedFiles.push(file); } updateFileList(); }
        function updateFileList() { 
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-item-details">
                        <span class="file-name" title="${file.name}">${file.name}</span>
                        <span class="file-size">${formatFileSize(file.size)}</span>
                    </div>
                    <button class="remove-file" onclick="removeFile(${index})" title="Remove file">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                `;
                fileList.appendChild(fileItem);
            });
            if (fileListHeader) fileListHeader.style.display = selectedFiles.length > 0 ? 'block' : 'none';
        }
        function removeFile(index) { selectedFiles.splice(index, 1); updateFileList(); }
        function formatFileSize(bytes) { if (bytes === 0) return '0 Bytes'; const k = 1024; const sizes = ['Bytes', 'KB', 'MB', 'GB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]; }
        
        function showPayment() { 
            if (selectedFiles.length === 0) { alert('Please select files to convert first!'); return; } 
            const outputFormat = document.getElementById('outputFormat').value; 
            if (!outputFormat) { alert('Please select an output format!'); return; } 
            if (paymentModal) paymentModal.classList.add('active');
        }
        function closePayment() { 
            if (paymentModal) paymentModal.classList.remove('active');
            const payButton = document.querySelector('.pay-btn'); 
            if (payButton) { payButton.disabled = false; payButton.textContent = 'Pay Now & Start Converting'; } 
        }
        
        function processPayment() {
            const stripe = Stripe('pk_test_51RWdDYG7Nhle0D1Q16kgmnfcDyGFrOwkh5oeO0X5YfnfHLkWinieJ8vFHqUC6SkXeG5GQgG0pSM91CJ2cq5ZaXa4003LfaYsDd');
            const payButton = document.querySelector('.pay-btn');
            if (payButton) { payButton.disabled = true; payButton.textContent = 'Processing...'; }
            fetch('/create-checkout-session', { method: 'POST', headers: { 'Content-Type': 'application/json' }})
            .then(response => { if (!response.ok) { return response.json().then(errData => { throw new Error(errData.error || `Server error: ${response.status}`); }).catch(() => { throw new Error(`Server error: ${response.status}`); }); } return response.json(); })
            .then(session => stripe.redirectToCheckout({ sessionId: session.id }))
            .then(result => { if (result && result.error) { console.error('Stripe redirectToCheckout error:', result.error.message); alert('Could not redirect to Stripe: ' + result.error.message); if (payButton) { payButton.disabled = false; payButton.textContent = 'Pay Now & Start Converting'; }}})
            .catch(error => { console.error('Error in processPayment:', error); alert('Payment processing failed: ' + error.message); if (payButton) { payButton.disabled = false; payButton.textContent = 'Pay Now & Start Converting'; }});
        }

        function readFileAsBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onloadend = () => resolve(reader.result); reader.onerror = (error) => reject(error); }); }

        async function processSingleImageConversion(file, outputFormat) { 
             try {
                const imageBase64 = await readFileAsBase64(file);
                const response = await fetch('/convert-image', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ imageBase64, outputFormat, inputFileName: file.name }) });
                if (!response.ok) { const errData = await response.json().catch(() => ({ error: "Failed to parse server error."})); throw new Error(errData.error || `Image conversion error for ${file.name}: ${response.status}`); }
                const result = await response.json();
                return { status: 'fulfilled', fileName: result.fileName, mimeType: result.mimeType, data: result.data };
            } catch (error) { console.error(`Error converting ${file.name} to ${outputFormat}:`, error); return { status: 'rejected', originalFileName: file.name, reason: error.message }; }
        }

        async function processSingleImageToPdfConversion(file) { 
            try {
                const imageBase64 = await readFileAsBase64(file);
                const response = await fetch('/image-to-pdf', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ imageBase64, inputFileName: file.name }) });
                if (!response.ok) { const errData = await response.json().catch(() => ({ error: "Failed to parse server error."})); throw new Error(errData.error || `Image-to-PDF conversion error for ${file.name}: ${response.status}`); }
                const result = await response.json();
                return { status: 'fulfilled', fileName: result.fileName, mimeType: result.mimeType, data: result.data };
            } catch (error) { console.error(`Error converting ${file.name} to PDF:`, error); return { status: 'rejected', originalFileName: file.name, reason: error.message }; }
        }

        async function handlePaidConversion() { 
            if (!convertBtn) return;
            if (selectedFiles.length === 0) { alert('Please select files to convert first!'); return; }
            const outputFormatValue = document.getElementById('outputFormat').value;
            if (!outputFormatValue) { alert('Please select an output format!'); return; }

            convertBtn.disabled = true;
            convertBtn.innerHTML = `Converting ${selectedFiles.length} file(s)...`;

            const conversionPromises = [];
            const targetFormat = outputFormatValue.toLowerCase();
            const successfullyConvertedFilesData = [];
            const batchSummaryMessages = [];

            const imageInputTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'image/tiff', 'image/svg+xml'];
            const imageOutputTargetsForImageFunction = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'tiff']; 

            for (const fileToConvert of selectedFiles) {
                const inputFileType = fileToConvert.type.toLowerCase();
                if (imageInputTypes.includes(inputFileType)) {
                    if (imageOutputTargetsForImageFunction.includes(targetFormat)) {
                        conversionPromises.push(processSingleImageConversion(fileToConvert, targetFormat));
                    } else if (targetFormat === 'pdf') {
                        conversionPromises.push(processSingleImageToPdfConversion(fileToConvert));
                    } else { conversionPromises.push(Promise.resolve({status: 'rejected', originalFileName: fileToConvert.name, reason: `Unsupported output '${targetFormat}' for this image.`})); }
                } else { conversionPromises.push(Promise.resolve({status: 'rejected', originalFileName: fileToConvert.name, reason: `Unsupported input type '${inputFileType}'.`})); }
            }

            const results = await Promise.allSettled(conversionPromises);
            let successCount = 0; let failCount = 0;

            results.forEach(result => {
                if (result.status === 'fulfilled' && result.value.status === 'fulfilled') {
                    successCount++; successfullyConvertedFilesData.push(result.value);
                } else {
                    failCount++;
                    const fileName = result.value?.originalFileName || (result.reason?.originalFileName || (result.value && result.value.fileName) || 'Unknown file');
                    const reason = result.value?.reason || result.reason?.message || 'Unknown error';
                    batchSummaryMessages.push(`Failed: ${fileName} - ${reason}`);
                }
            });

            if (successfullyConvertedFilesData.length > 0) {
                if (typeof JSZip === "undefined" || typeof saveAs === "undefined") {
                    alert("Error: ZIP library not loaded. Attempting individual downloads.");
                    successfullyConvertedFilesData.forEach(fileData => { const link = document.createElement('a'); link.href = `data:${fileData.mimeType};base64,${fileData.data}`; link.download = fileData.fileName; document.body.appendChild(link); link.click(); document.body.removeChild(link); });
                    batchSummaryMessages.unshift("Individual downloads initiated (ZIP creation library failed).");
                } else {
                    const zip = new JSZip();
                    successfullyConvertedFilesData.forEach(fileData => { zip.file(fileData.fileName, fileData.data, { base64: true }); });
                    try {
                        const zipBlob = await zip.generateAsync({ type: "blob" });
                        saveAs(zipBlob, "converted_files.zip"); 
                        batchSummaryMessages.unshift(`${successCount} file(s) converted and zipped successfully!`);
                    } catch (zipError) {
                        console.error("Error generating ZIP:", zipError);
                        batchSummaryMessages.unshift("Error creating ZIP file. Attempting individual downloads.");
                        successfullyConvertedFilesData.forEach(fileData => { const link = document.createElement('a'); link.href = `data:${fileData.mimeType};base64,${fileData.data}`; link.download = fileData.fileName; document.body.appendChild(link); link.click(); document.body.removeChild(link);});
                    }
                }
            }
            
            if (batchSummaryMessages.length > 0) { alert(`Batch Conversion Summary:\n${batchSummaryMessages.join('\n')}`); } 
            else if (failCount > 0 && successCount === 0) { alert(`All ${failCount} file(s) failed to convert.`); } 
            else if (successCount === 0 && failCount === 0 && selectedFiles.length > 0) { alert("No files were eligible for the selected conversion.");}
            
            convertBtn.disabled = false;
            checkPaymentStatus();
        }

        function checkPaymentStatus() { 
            if (!convertBtn) { console.error("Convert button not found!"); return; }
            if (localStorage.getItem('hasPaidForBatchConvertPro') === 'true') {
                convertBtn.innerHTML = 'Convert Files Now (Unlimited Access)';
                convertBtn.onclick = handlePaidConversion; 
            } else {
                convertBtn.innerHTML = 'Convert Files ($12.99 - Unlock Unlimited)';
                convertBtn.onclick = showPayment;
            }
        }
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize payment modal JS variable after DOM is loaded
            // paymentModal = document.getElementById('paymentModal'); // Already global
            // fileListHeader = document.getElementById('fileListHeader'); // Already global
            checkPaymentStatus();
        });
        window.addEventListener('pageshow', (event) => { if (event.persisted) { checkPaymentStatus(); } });
    </script>
</body>
</html>